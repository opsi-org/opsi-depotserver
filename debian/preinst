#! /bin/bash
# preinst script for opsi-depotserver
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
#
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install)
    	HOSTNAME=`uname -n`
	DOMAIN=`hostname -d`
	FQDN=`hostname --fqdn`
	IPADDRESS=`getent hosts $FQDN | cut -d' ' -f1`
	
	for iface in `ifconfig -a | grep "^[[:alnum:]]" | cut -d " " -f 1`; do
	    ip=`ifconfig $iface | grep "\:[[:digit:]]*\." | sed "s/:/ /g" | awk '{ printf $3}'`
	    NETMASK=`ifconfig $iface | grep "\:[[:digit:]]*\." | sed "s/:/ /g" | awk '{ printf $7}'`
	    GATEWAY=`route -n | grep ^0.0.0.0 | awk '{ printf $2}'`
	    if [ "$ip" != "" ]; then
	        if [ "$IPADDRESS" = "" ]; then
		    IPADDRESS="$ip"
		fi
		[ "$IPADDRESS" = "$ip" ] && break
	    fi
	done
	
	[ "$NETMASK" = "" ] && NETMASK="255.255.225.0"
	
	if [ "$IPADDRESS" != "" ]; then
	    for part in 1 2 3 4; do
		I[$part]=$(echo $IPADDRESS | cut -d . -f $part)
		M[$part]=$(echo $NETMASK | cut -d . -f $part)
	    done
		    
	    for part in 1 2 3 4; do
		N[$part]=$((${I[$part]} & ${M[$part]}))
	        B[$part]=$((${N[$part]} | $((${M[$part]} ^255))))
	    done
	
	    SUBNET="${N[1]}.${N[2]}.${N[3]}.${N[4]}"
	    BROADCAST="${B[1]}.${B[2]}.${B[3]}.${B[4]}"
	fi
	
	writeDepotIni=false
	if [ -e /var/lib/opsi/config/depots/$FQDN/depot.ini ]; then
		set +e
		grep -i "urlForClient" /var/lib/opsi/config/depots/$FQDN/depot.ini >/dev/null 2>/dev/null	
		status=$?
		set -e
		if [ $status = 0 ]; then
			# Old version (before opsi 3.3) of ini file found
			writeDepotIni=true
		fi
	else
		writeDepotIni=true
	fi
	
	if $writeDepotIni; then
		mkdir -p /var/lib/opsi/config/depots/$FQDN >/dev/null 2>/dev/null || true
		chmod -R 777 /var/lib/opsi
		
		echo "[depotshare]" 						>  /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "remoteurl = smb://$HOSTNAME/opt_pcbin/install"		>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "localurl = file:///opt/pcbin/install"			>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo ""								>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "[depotserver]"						>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "notes ="							>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "network = $SUBNET/$NETMASK"				>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "description ="						>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo ""								>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "[repository]"						>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "remoteurl = webdavs://$FQDN:4447/products"		>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		echo "localurl = file:///var/lib/opsi/products"		>> /var/lib/opsi/config/depots/$FQDN/depot.ini
		
		chmod 664 /var/lib/opsi/config/depots/$FQDN/depot.ini
	fi
	
	mkdir -p /var/lib/opsi/products
	chown -R pcpatch:pcpatch /var/lib/opsi
	chmod 2750 /var/lib/opsi
	chmod 2770 /var/lib/opsi/products
	chmod 0660 /var/lib/opsi/products/* >/dev/null 2>/dev/null || true
    ;;

    upgrade)
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

